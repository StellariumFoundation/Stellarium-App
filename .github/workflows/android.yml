name: Build and Release Official v1.0 (Signed)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # --- NEW STEP: Decode the Keystore ---
    - name: Decode Keystore
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        # Decodes the base64 secret and saves it as 'release.keystore' in the app folder
        echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/release.keystore

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # --- BUILD STEP: Signed Release ---
    - name: Build Optimized Signed APKs
      env:
        # These env vars match what we wrote in build.gradle.kts
        KEYSTORE_PATH: "release.keystore"
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: ./gradlew assembleRelease --parallel --build-cache

    - name: List Build Outputs (Debugging)
      run: |
        echo "Verifying Release output..."
        ls -R app/build/outputs/apk/release/

    - name: Prepare and Rename 1.0 Artifacts
      id: prepare_apks
      run: |
        mkdir -p release_apks
        
        # NOTE: Release APKs are in 'release', not 'debug'
        BASE_PATH="app/build/outputs/apk/release"
        
        # Define the Version Name
        APP_NAME="Stellarium-v1.0"
        
        # 1. Universal (Works on all phones)
        if [ -f "$BASE_PATH/app-universal-release.apk" ]; then
          cp "$BASE_PATH/app-universal-release.apk" "release_apks/${APP_NAME}-Universal.apk"
        fi
        
        # 2. ARM64 (Modern Phones)
        if [ -f "$BASE_PATH/app-arm64-v8a-release.apk" ]; then
          cp "$BASE_PATH/app-arm64-v8a-release.apk" "release_apks/${APP_NAME}-ARM64.apk"
        fi
        
        # 3. ARMv7 (Older/Budget Phones)
        if [ -f "$BASE_PATH/app-armeabi-v7a-release.apk" ]; then
          cp "$BASE_PATH/app-armeabi-v7a-release.apk" "release_apks/${APP_NAME}-ARMv7.apk"
        fi
        
        # 4. x86_64 (PC Emulators)
        if [ -f "$BASE_PATH/app-x86_64-release.apk" ]; then
          cp "$BASE_PATH/app-x86_64-release.apk" "release_apks/${APP_NAME}-x64.apk"
        fi
        
        echo "Signed APKs prepared for release."

    - name: Create Official Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/heads/master')
      with:
        tag_name: v1.0-official-${{ github.run_number }}
        name: Stellarium Official App v1.0 (Signed)
        body: |
          # ðŸŒŸ Official Release v1.0
          
          This is the production-ready build of the Stellarium Foundation App.
          
          ### ðŸš€ Ultra-Optimized
          - **Signed & Verified:** Authenticated with the official Stellarium key.
          - **R8 & ZipAlign:** Max performance, min memory usage.
          - **Java 17:** Runtime speed improvements.
          
          ### ðŸ“¥ Downloads
          - **Recommended:** `Stellarium-v1.0-Universal.apk`
          - **Modern Phones:** `Stellarium-v1.0-ARM64.apk`
        draft: false
        prerelease: false
        files: |
          release_apks/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
