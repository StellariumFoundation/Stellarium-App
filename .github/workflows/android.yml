name: Build and Release Official (Signed)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # --- Step: Extract Version Name from Gradle ---
      # This assumes your app/build.gradle.kts has a line like: versionName = "1.0"
      - name: Extract Version Name
        id: extract_version
        run: |
          # Use grep and sed to find the line with versionName and extract the value
          # Works for both Kotlin DSL (versionName = "x.y") and Groovy (versionName "x.y")
          VERSION_NAME=$(grep -oP 'versionName\s*=?\s*"\K[^"]+' app/build.gradle.kts)
          
          echo "Detected Version: $VERSION_NAME"
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/release.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Optimized Signed APKs
        env:
          KEYSTORE_PATH: "release.keystore"
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --parallel --build-cache

      - name: Prepare Artifacts with Dynamic Version
        run: |
          mkdir -p release_apks
          BASE_PATH="app/build/outputs/apk/release"
          
          # Use the extracted version name
          APP_PREFIX="Stellarium-v${{ env.VERSION_NAME }}"
          
          echo " renaming APKs to ${APP_PREFIX}-*.apk"

          # 1. Universal
          if [ -f "$BASE_PATH/app-universal-release.apk" ]; then
            cp "$BASE_PATH/app-universal-release.apk" "release_apks/${APP_PREFIX}-Universal.apk"
          fi
          
          # 2. ARM64
          if [ -f "$BASE_PATH/app-arm64-v8a-release.apk" ]; then
            cp "$BASE_PATH/app-arm64-v8a-release.apk" "release_apks/${APP_PREFIX}-ARM64.apk"
          fi
          
          # 3. ARMv7
          if [ -f "$BASE_PATH/app-armeabi-v7a-release.apk" ]; then
            cp "$BASE_PATH/app-armeabi-v7a-release.apk" "release_apks/${APP_PREFIX}-ARMv7.apk"
          fi
          
          # 4. x86_64
          if [ -f "$BASE_PATH/app-x86_64-release.apk" ]; then
            cp "$BASE_PATH/app-x86_64-release.apk" "release_apks/${APP_PREFIX}-x64.apk"
          fi

          # 5. x86
          if [ -f "$BASE_PATH/app-x86-release.apk" ]; then
            cp "$BASE_PATH/app-x86-release.apk" "release_apks/${APP_PREFIX}-x86.apk"
          fi

      - name: Create Official Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/heads/master')
        with:
          tag_name: v${{ env.VERSION_NAME }}
          name: üèõÔ∏è Stellarium Foundation App v${{ env.VERSION_NAME }} (Official Release)
          body: |
            # The Stellarium Foundation: Version ${{ env.VERSION_NAME }}
            
            > *"An institution to propel global wealth creation and wellness."*
            
            We are proud to announce the **Official v${{ env.VERSION_NAME }} Release** of the Stellarium mobile application.
            
            ---
            
            ### ‚ú® Highlights
            
            *   **üîê Secure & Signed:** Authenticated with the official Stellarium cryptographic signature.
            *   **‚ö° Ultra-Optimized:** Built with R8 obfuscation and Zipalign.
            *   **üåç Global Access:** Localized architecture support.
            
            ---
            
            ### üì• Download Guide
            
            | Device Type | Recommended File |
            | :--- | :--- |
            | **Most Users** | `Stellarium-v${{ env.VERSION_NAME }}-Universal.apk` |
            | **Modern Phones** | `Stellarium-v${{ env.VERSION_NAME }}-ARM64.apk` |
            | **Older Phones** | `Stellarium-v${{ env.VERSION_NAME }}-ARMv7.apk` |
            | **Emulators** | `Stellarium-v${{ env.VERSION_NAME }}-x64.apk` |
            
            ---
            
            *Built with precision. Deployed for impact.*
          draft: false
          prerelease: false
          files: |
            release_apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
